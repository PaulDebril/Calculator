name: CI & DÃ©ploiement sur VPS OVH

on:
  push:
    branches:
      - main

  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  ci-checks:
    name: VÃ©rifications CI (Lint, Format, Tests)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Installer Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Installer les dÃ©pendances
      run: npm install

    - name: VÃ©rification Prettier
      run: npm run format:check

    - name: VÃ©rification ESLint
      run: npm run lint

  deploy:
    name: DÃ©ploiement sur VPS
    runs-on: ubuntu-latest
    needs: ci-checks 
    if: github.event.pull_request.merged == true || github.event_name == 'push'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Connexion SSH et dÃ©ploiement
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
            echo "â¡ï¸ DÃ©but du script sur le VPS"
            echo "ğŸ“‚ RÃ©pertoire courant :"
            pwd
          
            echo "ğŸ‘¤ Utilisateur courant :"
            whoami
          
            echo "ğŸ“ Contenu du dossier home :"
            ls -la ~
          
            echo "ğŸ“ Contenu de /home/pauldebril/apps/Calculator :"
            ls -la /home/pauldebril/apps/Calculator
          
            echo "ğŸš€ Lancement du pull Git"
            cd /home/pauldebril/apps/Calculator
            git pull origin main --rebase
          
            echo "ğŸ³ Docker Compose Down"
            docker compose down
          
            echo "ğŸ“¦ Docker Compose Build + Up"
            docker compose up -d --build

