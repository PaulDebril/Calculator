name: DÃ©ploiement CI/CD sur VPS

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    name: DÃ©ployer Calculator sur VPS
    runs-on: ubuntu-latest

    steps:
    - name: RÃ©cupÃ©ration du code
      uses: actions/checkout@v3

    - name: Connexion SSH et dÃ©ploiement
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
            echo "â¡ï¸ DÃ©but du script sur le VPS"
            echo "ğŸ“‚ RÃ©pertoire courant :"
            pwd
          
            echo "ğŸ‘¤ Utilisateur courant :"
            whoami
          
            echo "ğŸ“ Contenu du dossier home :"
            ls -la ~
          
            echo "ğŸ“ Contenu de /home/pauldebril/apps/Calculator :"
            ls -la /home/pauldebril/apps/Calculator
          
            echo "ğŸš€ Lancement du pull Git"
            cd /home/pauldebril/apps/Calculator
            git pull origin main --rebase
          
            echo "ğŸ³ Docker Compose Down"
            docker compose down
          
            echo "ğŸ“¦ Docker Compose Build + Up"
            docker compose up -d --build
